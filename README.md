# Getting Started with ETW: Fundamentals for Cyber Defenders
# What is ETW?
According to Microsoft, Event Tracing For Windows (ETW) is a general-purpose, high-speed tracing facility provided by the operating system.
 Using a buffering and logging mechanism implemented in the kernel, ETW provides a tracing mechanism for events raised by both user-mode applications and kernel-mode device drivers.

- At the core of it, ETW is a more verbose version of Windows Event Logs (EVTX). A lot of Windows Event Logs actually come from ETW providers. The big difference is ETW does not log by default, it needs to be enabled before it will start reporting events.
  - Note: While .ETL files have a similar structure as .EVTX files, they are not the same. Because of this, some evtx parsers may not be able to parse an .ETL file.

# Architecture
The following diagram showcase how the ETW architecture is laid out:

<img src="https://i.imgur.com/aFbhoZS.png" height="60%" width="60%" alt="ETW"/> 

## ETW works in three parts:
1. <b>Controllers</b> start and stop Event Tracing Sessions. These sessions can subscribe to 1 or more providers, enabling the providers to start logging. 
2. <b>Providers</b> are where the events come from. Due to the sheer number of events some of these providers can generate, they’re disabled unless a Tracing Session is actively using it. 
3. <b>Consumers</b> take the generated events and handle them. The default method of handling events is outputting them to an .ETL file, but another example of a consumer is using the Windows API.

# Interacting With ETW 
- <b><ins>Logman</b></ins> is one of the built in tools for handling ETW and Event Tracing Sessions. You can use Logman to query, create, start and stop tracing sessions, which can be great for understanding what sessions are readily available for collection or starting your own collection. 
- Employing the -ets parameter will allow for a direct investigation of the event tracing sessions, providing insights into system-wide tracing sessions. As an example, the Sysmon Event Tracing Sessions can be found towards the end of the displayed information.

<img src="https://i.imgur.com/gHXqxLg.png" height="60%" width="60%" alt="ETW"/>
<img src="https://i.imgur.com/xIFdmEB.png" height="60%" width="60%" alt="ETW"/>

- When we examine an Event Tracing Session directly, we uncover specific session details including the Name, Max Log Size, Log Location, and the subscribed providers. This information is invaluable for incident responders. Discovering a session that records providers relevant to your interests may provide crucial logs for an investigation.

  - <b>Please note</b> that the “-ets” parameter is vital to the command. Without it, Logman will not identify the Event Tracing Session.

- For each provider subscribed to the session, we can acquire critical data:
  - <b>Name / Provider GUID</b>: This is the exclusive identifier for the provider.
  - <b>Level</b>: This describes the event level, indicating if it's filtering for warning, informational, critical, or all events.
  - <b>Keywords Any</b>: Keywords create a filter based on the kind of event generated by the provider.

<img src="https://i.imgur.com/LaC9Wjq.png" height="60%" width="60%" alt="ETW">

- By using the logman query providers command, we can generate a list of all available providers on the system, including their respective GUIDs.
  - Windows 10 includes more than 1,000 built-in providers. Moreover, Third-Party Software often incorporates its own ETW providers, especially those operating in Kernel mode.
 
- Due to the high number of providers, it's usually advantageous to filter them using <b><ins>findstr</b></ins>. For instance, you will see multiple results for "Winlogon" in the given example.

<img src="https://i.imgur.com/KoBQzKo.png" height="60%" width="60%" alt="ETW">

- By specifying a provider with Logman, we gain a deeper understanding of the provider's function. This will inform us about the Keywords we can filter on, the available event levels, and which processes are currently utilizing the provider.

<img src="https://i.imgur.com/SeuxI40.png" height="60%" width="60%" alt="ETW">

- The Microsoft-Windows-Winlogon/Diagnostic and Microsoft-Windows-Winlogon/Operational keywords reference the event logs generated from this provider.

- GUI-based alternatives also exist. These are:
  - Using the graphical interface of the Performance Monitor tool, we can visualize various running trace sessions. A detailed overview of a specific trace can be accessed simply by double-clicking on it.
  - This reveals all pertinent data related to the trace, from the engaged providers and their activated features to the nature of the trace itself.
  - Additionally, these sessions can be modified to suit our needs by incorporating or eliminating providers.
  - Lastly, we can devise new sessions by opting for the "User Defined" category.

<img src="https://i.imgur.com/TjQjhUZ.png" height="60%" width="60%" alt="ETW">
<img src="https://i.imgur.com/aWrZLID.png" height="60%" width="60%" alt="ETW">
